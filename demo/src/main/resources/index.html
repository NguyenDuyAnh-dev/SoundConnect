<!DOCTYPE html>
<html>
<head>
    <title>WebSocket STOMP Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<h2>WebSocket STOMP Test</h2>

<label>Room ID: <input type="number" id="roomInput" value="15" /></label>
<input type="text" id="msgInput" placeholder="Type message..." />
<button onclick="connect()">Connect</button>
<button onclick="sendMsg()">Send Msg</button>

<pre id="log" style="height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px;"></pre>

<script>
    let stompClient = null;
    let roomId = null;
    const currentUserId = "38925c47-e0f7-41ad-ba76-19a08fe5125a"; // userId của bạn

    function connect() {
        const roomInput = document.getElementById("roomInput").value;
        roomId = parseInt(roomInput);
        if (!roomId) {
            alert("Please enter a valid Room ID");
            return;
        }

        const socket = new SockJS("http://localhost:8080/identity/gs-guide-websocket");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, frame => {
            log("Connected: " + frame);

            // Load lịch sử tin nhắn khi connect xong
            loadHistory();

            // Subscribe topic WebSocket
            stompClient.subscribe("/topic/room/" + roomId, msg => {
                const message = JSON.parse(msg.body);

                // Chỉ hiển thị tin nhắn của người khác
                if (message.senderId !== currentUserId) {
                    log("Other: " + message.content);
                }
            });
        });
    }

    async function loadHistory() {
        try {
            const res = await fetch(`http://localhost:8080/room/${roomId}/messages`);
            const messages = await res.json();
            messages.forEach(msg => {
                if(msg.senderId === currentUserId){
                    log("Me: " + msg.content);
                } else {
                    log("Other: " + msg.content);
                }
            });
        } catch(err) {
            console.error("Failed to load history", err);
        }
    }

    function sendMsg() {
        const input = document.getElementById("msgInput");
        const content = input.value.trim();
        if (!content) return;

        const message = {
            content: content,
            senderId: currentUserId,
            chatRoomId: roomId
        };

        // Hiển thị ngay cho chính mình
        log("Me: " + message.content);

        // Gửi WebSocket
        stompClient.send("/app/chat/" + roomId + "/sendMessage", {}, JSON.stringify(message));

        input.value = "";
    }

    function log(text) {
        const logEl = document.getElementById("log");
        logEl.innerText += text + "\n";
        logEl.scrollTop = logEl.scrollHeight;
    }
</script>
</body>
</html>
